# Description: Gobject interface for udev
# URL: http://gudev.sourceforge.net
# Maintainer: Jose V Beneyto, sepen at crux dot nu
# Packager: Jose V Beneyto, sepen at crux dot nu
# Depends on: udev glib
# Group: xfce4

name=broadcom-sta
version=6.30.223.141
pversion=6_30_223_141
release=3.13.3
source=(http://www.broadcom.com/docs/linux_sta/hybrid-v35-nodebug-pcoem-$pversion.tar.gz
	linux-recent.patch
	license.patch)

build() {
	patch -p1 -i linux-recent.patch
	patch -p1 -i license.patch

	KBUILD_NOPEDANTIC=1 make -C /usr/src/kernels/${release}TS M=`pwd` V=1
	mkdir -p $PKG/lib/modules/${release}TS/kernel/drivers/net/wireless
	cp -a wl.ko $PKG/lib/modules/${release}TS/kernel/drivers/net/wireless

	KBUILD_NOPEDANTIC=1 make -C /usr/src/kernels/${release}TS M=`pwd` clean

	KBUILD_NOPEDANTIC=1 make -C /usr/src/kernels/${release}TS_SMP M=`pwd`
	mkdir -p $PKG/lib/modules/${release}TS_SMP/kernel/drivers/net/wireless
	cp -a wl.ko $PKG/lib/modules/${release}TS_SMP/kernel/drivers/net/wireless

	mkdir -p  $PKG/usr/share/$name
	cp lib/LICENSE.txt $PKG/usr/share/$name/.

	mkdir -p $PKG/etc/modprobe.d
	echo "# Make sure that the wl driver gets loaded and not the ssb driver" > $PKG/etc/modprobe.d/$name.conf
	modinfo wl.ko | grep alias | sed -e 's/alias: *\(.*\)/alias \1 wl/' >> $PKG/etc/modprobe.d/$name.conf
	echo "install ssb modprobe wl; modprobe --ignore-install ssb" >> $PKG/etc/modprobe.d/$name.conf

}
